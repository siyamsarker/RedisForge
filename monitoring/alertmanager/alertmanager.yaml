# ================================================================================
# Alertmanager Configuration for RedisForge
# ================================================================================
# This configuration sends Push Gateway alerts to Discord via webhook
#
# SETUP:
# 1. Create Discord webhook:
#    - Open Discord Server Settings → Integrations → Webhooks
#    - Click "New Webhook"
#    - Copy webhook URL
# 2. Replace <YOUR_DISCORD_WEBHOOK_URL> below with your actual webhook URL
# 3. Deploy Alertmanager with this config
# 4. Test: curl -X POST http://alertmanager:9093/-/reload
#
# ================================================================================

global:
  resolve_timeout: 5m
  # Discord webhook URL format:
  # discord_webhook_url: 'https://discord.com/api/webhooks/<id>/<token>'

# Route configuration
route:
  # Default receiver for all alerts
  receiver: 'discord-default'
  
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # Wait time before sending first notification
  group_wait: 10s
  
  # Wait time before sending notification about new alerts in the same group
  group_interval: 10s
  
  # Wait time before sending notification about resolved alerts
  repeat_interval: 12h

  # Route Push Gateway alerts to Discord
  routes:
    # Push Gateway specific alerts → Discord
    - match:
        component: monitoring
      receiver: 'discord-pushgateway'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 4h
      continue: false

    # Critical alerts → Discord with high priority
    - match:
        severity: critical
      receiver: 'discord-critical'
      group_wait: 5s
      repeat_interval: 1h
      continue: true

# Receivers configuration
receivers:
  # Discord receiver for Push Gateway alerts
  - name: 'discord-pushgateway'
    webhook_configs:
      - url: '<YOUR_DISCORD_WEBHOOK_URL>/slack'  # Discord supports Slack-compatible webhooks
        send_resolved: true
        http_config:
          follow_redirects: true

  # Discord receiver for critical alerts
  - name: 'discord-critical'
    webhook_configs:
      - url: '<YOUR_DISCORD_WEBHOOK_URL>/slack'
        send_resolved: true
        http_config:
          follow_redirects: true

  # Default Discord receiver for other alerts
  - name: 'discord-default'
    webhook_configs:
      - url: '<YOUR_DISCORD_WEBHOOK_URL>/slack'
        send_resolved: true
        http_config:
          follow_redirects: true

# Inhibition rules - prevent notification spam
inhibit_rules:
  # If Push Gateway is down, don't alert on delayed metrics
  - source_match:
      alertname: 'PushGatewayDown'
    target_match:
      alertname: 'MetricsPushDelayed'
    equal: ['cluster']

  # If metrics push service is down, don't alert on delayed metrics
  - source_match:
      alertname: 'MetricsPushServiceDown'
    target_match:
      alertname: 'MetricsPushDelayed'
    equal: ['instance']

# ================================================================================
# DISCORD WEBHOOK SETUP GUIDE
# ================================================================================
# 
# Step 1: Create Discord Webhook
# --------------------------------
# 1. Open your Discord server
# 2. Go to Server Settings → Integrations → Webhooks
# 3. Click "New Webhook"
# 4. Name it "RedisForge Alerts" or similar
# 5. Select the channel (e.g., #alerts, #monitoring)
# 6. Copy the webhook URL
# 7. The URL format: https://discord.com/api/webhooks/<webhook_id>/<webhook_token>
#
# Step 2: Configure This File
# ----------------------------
# Replace all instances of '<YOUR_DISCORD_WEBHOOK_URL>' with your actual webhook URL
# Note: Add '/slack' at the end for Slack-compatible format
#
# Example:
# url: 'https://discord.com/api/webhooks/123456789/abcdefghijklmnop/slack'
#
# Step 3: Deploy Alertmanager
# ----------------------------
# Deploy Alertmanager with this configuration file
#
# Step 4: Test the Setup
# -----------------------
# Send a test alert:
#
# curl -XPOST http://alertmanager:9093/api/v1/alerts -d '[{
#   "labels": {
#     "alertname": "TestAlert",
#     "severity": "warning",
#     "component": "monitoring"
#   },
#   "annotations": {
#     "summary": "Test alert from RedisForge",
#     "description": "This is a test alert to verify Discord integration"
#   }
# }]'
#
# You should see the alert in your Discord channel within seconds.
#
# ================================================================================
# TROUBLESHOOTING
# ================================================================================
#
# Alert not showing in Discord:
# - Verify webhook URL is correct (copy-paste from Discord)
# - Ensure '/slack' is appended to the webhook URL
# - Check Alertmanager logs: docker logs alertmanager
# - Verify webhook is active in Discord Server Settings
# - Test webhook directly:
#   curl -X POST '<YOUR_DISCORD_WEBHOOK_URL>/slack' \
#     -H 'Content-Type: application/json' \
#     -d '{"text": "Test message from RedisForge"}'
#
# Webhook rate limits:
# - Discord limits: 30 requests per 60 seconds per webhook
# - Adjust repeat_interval if hitting rate limits
#
# ================================================================================
